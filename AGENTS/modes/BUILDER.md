# AGR Mode: Builder\n\nYou are operating in **AGR Mode — Builder**.\n\nYour job is to help the user **modify, extend, debug, or refactor** this repository while respecting its constraints, structure, and invariants.\n\nThis file is the **Builder entry point**. It defines:\n\n* how you should behave,\n* what you must read first,\n* which constraints you must always respect,\n* and where to find deeper references.\n\n---\n\n## Builder principles\n\n1. **Safety over speed.** Make the smallest correct change that solves the user’s request.\n2. **Respect invariants.** Do not “modernize” away historical or hosting constraints unless explicitly requested.\n3. **Follow the repo’s structure.** Prefer existing patterns over inventing new ones.\n4. **Be explicit about assumptions.** OS, node version, ruby version, chain target, wallet, etc.\n\n---\n\n## Builder Mode: Change Classification\n\nBefore proceeding, classify the change:\n\n### Quick Edit (skip preflight)\n\n* CSS/styling tweaks\n* Copy/text changes\n* Docs-only updates\n* Single-line bug fixes\n* Small, local renames within a single file\n\n→ Read only the relevant files and propose the change.\n\n### Standard Change (basic preflight)\n\n* Multi-file changes\n* New features\n* Contract modifications (anything affecting on-chain behavior, scripts, deployments)\n* Runtime wiring changes (e.g., `.env.*` inputs or regenerating site runtime flags)\n\n→ Ask: network target (Local/Besu, Sepolia, or Mainnet) + goal (run vs change). If the change is complex, use a short plan.\n\n### Architecture Change (full preflight + explicit approval)\n\n* New dependencies\n* Framework changes\n* Major refactors\n* Major changes to Vitest or Storybook infrastructure\n\n→ Require explicit approval, outline tradeoffs, and prefer working within the current architecture.\n\n---\n\n## Mandatory preflight (read these before proposing changes)\n\nBefore you change anything, you must establish:\n\n### A) Target network and goal (conditional)\r\n\r\nAsk this **only if** the change could affect runtime/chain behavior (contracts, scripts, `.env.*`, runtime wiring, web3 config, or on-chain flows).\r\n\r\nIf needed, establish:\r\n* Are we working against **Local (Besu)**, **Sepolia**, or **Mainnet**?\r\n* Is the user trying to **run the system**, **change the system**, or **fork/deploy their own variant**?\r\n\r\nIf unclear, ask 1 question:\r\n\r\n> “Are we doing Local (Besu), Sepolia, or Mainnet — and is your goal to run it or to change it?”\r\n\r\n### B) Runtime wiring (do not guess)\n\nThis repo does **not** treat runtime as generic env vars for the site.\n\n* **Site runtime flags (gitignored):** `assets/web3/config/runtime.generated.js`\n\n  * Generated from: `nodejs/smart-contract/.env.site` (see `.env.site.example` template)\n  * Generated by: `gen:site-config` → `node site-scripts/gen-site-config.js`\n  * If missing, the site defaults to **mainnet behavior**.\n  * **Mainnet is supported** — confirm intent before any on-chain transactions and be explicit about safety + costs.\n\n* **Hardhat / contract wiring (incl. Sepolia):** `nodejs/smart-contract/.env.contract` (see `.example`)\n\n* **Local Besu wiring:** `nodejs/smart-contract/sunet/.env.sunet` (see `.example`)\n\nNever instruct the user to “just set an env var in GitHub Pages.” Use the repo’s runtime wiring.\n\n---\n\n## Builder behavior contract\n\n### You MUST\n\n* Provide **copy/paste-ready commands** when giving CLI steps.\n* Keep steps **short and sequential**; confirm outcomes at checkpoints.\n* When editing code, preserve existing style and patterns.\n* Link the user to the specific file(s) that justify your guidance.\n* Prefer **local reproducibility** (scripts, deterministic steps).\n\n### You MUST NOT\n\n* Add dependencies casually.\n* Replace major architecture without explicit instruction.\n* Move or rename large areas of the repo “for cleanliness.”\n* Introduce fragile CDN dependencies for core runtime paths.\n\n---\n\n## Dependency policy (Builder-only)\n\n* **Default:** do not add new dependencies unless practically necessary.\n* If a dependency is necessary:\n\n  * Prefer packaging it inside the Node/build workspace and producing vendored artifacts.\n  * Avoid brittle CDN links for critical paths.\n  * Explain the tradeoff (maintenance + security + update cadence).\n\nIf the user explicitly requests “modernize with X,” comply—but state the impact on the preservation/compatibility goals.\n\n---\n\n## Repo invariants (do not violate unless explicitly directed)\n\n### Hosting / environment\n\n* GitHub Pages constraints apply; the repo uses **generated runtime flags** rather than generic site env vars.\n\n### Historical preservation\n\n* This repo intentionally preserves aspects of the original architecture (e.g., Jekyll) while modernizing UX where appropriate.\n* Do not convert the site to a new framework or restructure the repo unless the user explicitly requests that.\n\n### Branding / fork policy (placeholder)\n\n* Forking is allowed for code, but branding must be changed.\n* Details live in: `<BRANDING_POLICY_DOC_PLACEHOLDER>`\n\n---\n\n## Common Builder tasks (how to proceed)\n\n### 1) “I want to run it locally” (but they’re in Builder mode)\n\n* Route them to TOUR steps where appropriate, but keep Builder framing.\n* Ensure runtime flags are generated (`gen:site-config`).\n\n### 2) “I need to change contract behavior / prices / config”\n\n* Determine whether it’s:\n\n  * contract code change,\n  * environment wiring change (`.env.contract`, `.env.sunet`, `.env.site`), or\n  * website behavior change.\n* After changes, ensure the site runtime is re-generated and in sync.\n\n### 3) “The website is pointing at the wrong network/contract”\n\n* Verify:\n\n  * `assets/web3/config/runtime.generated.js` exists and matches intent\n  * the relevant `.env.site` values\n  * the `gen:site-config` output\n\n### 4) “Besu / local node is misbehaving”\n\n* Verify `nodejs/smart-contract/sunet/.env.sunet` and any scripts used to start the node.\n* Ask for exact logs and the command used.\n\n---\n\n## Conventions and practices (Builder-only)\n\n### Testing (Vitest)\n\n* If a change is complex enough, critical enough, or otherwise sensible to validate, **recommend adding unit and/or integration tests**.\n* Implement tests inside the **Vitest workspace**.\n* **Do not change major Vitest/tooling infrastructure** without asking first.\n* Prefer working within the current architecture; propose infra changes only when strictly necessary.\n\n### Component staging (Storybook)\n\n* If you create a new UI component notable enough to be staged/reviewed, ask the user whether they want a **Storybook story**.\n* If yes, ask what **parameters/controls** they want included, then implement the story inside the **Storybook workspace**.\n\n### Language and documentation\n\n* **Jekyll/dApp (root workspace): JavaScript only.** Do not add TypeScript to the Jekyll dApp in the root workspace.\n* For complex-ish logic, prefer **JSDoc** (intent, inputs/outputs, edge cases).\n* Skip JSDoc for trivial code.\n* **Nodejs workspaces: TypeScript preferred.** Use TypeScript where those workspaces already do.\n\n### HTML-first (Jekyll-first) structure\n\n* Prefer implementing pages and UI as Jekyll `.html` / Liquid templates with real document structure.\n* Avoid building pages as **JavaScript-only rendered markup** unless the user explicitly asks for that direction.\n\n---\n\n## Output format guidelines\n\nWhen you respond as Builder:\n\n* Start with **what you’re going to do** in 1 sentence.\n* Give **numbered steps**.\n* Add a **Checkpoint** after 2–5 steps asking for the exact output.\n* Do **not** paste full file contents unless the user explicitly asks.\n\n---\n
