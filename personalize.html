<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <title>Su Squares, Blockchain Rentable Advertising</title>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-52764-25"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-52764-25');
  </script>
  <link rel="stylesheet" href="assets/main.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="assets/main.js"></script>
</head>
<body>
  <header>
    <a id="logo" href="index.html">Su Squares&trade;</a>
  </header>

  <div class="image-list">
  </div>

  <article class="lead">
    <h1>Personalize Squares</h1>
    <p><em>If you have any questions, please mail <a href="mailto:Su@TenThousandSu.com?subject=Su%20Squares&body=Hi%20Su%2C%0A%0APlease%20help!%20I%20have%20a%20question%20about%20Su%20Squares.%0A%0A">Su@TenThousandSu.com</a>. The price to personalize is 0.01 ether (10 finney), but the first three times are free.</em></p>
    <p>After the the third personalization, you must use the 10 finney button.</p>

    <div class="step-1-not-done">
      <h2>Step 1: Install MetaMask</h2>
      <p>You purchase Su Squares using ether and MetaMask is a Chrome/Firefox/Opera browser extension that lets you transact with Ethereum without creating a login here.</p>
      <p><a href="https://metamask.io/">Install MetaMask</a> to continue. Then reload this page.</p>
    </div>
    <div class="step-1-done" style="display:none">
      <h2>&#x2705; Installed MetaMask</h2>
    </div>

    <div class="step-2-not-done">
      <h2>Step 2: Login to mainnet</h2>
      <p>Switch to <strong>Main Network</strong> and login to your MetaMask wallet. Then reload this page.</p>
    </div>
    <div class="step-2-done" style="display:none">
      <h2>&#x2705; Using mainnet</h2>
    </div>

    <div class="step-3-not-done">
      <h2>Step 3: Enable your account</h2>
      <p>Click "Enable" in the MetaMask pop-up to enable Ethereum.</p>
    </div>
    <div class="step-3-done" style="display:none">
      <h2>&#x2705; Account enabled</h2>
    </div>

    <div class="step-3-done" style="display:none">
      <div class="step-4-not-done">
        <h2>Step 3: Personalize</h2>
        <p>You are using wallet <strong class="wallet-plug">NONE</strong> and you own <strong class="square-count">...</strong> squares.</p>
        <form class="step-4-not-done">
          <p><strong>Square number</strong><br>Must be owned by the wallet you are currently using</p>
          <select id="square-number" style="width:10em">
          </select>
          <hr>
          <p><strong>Image</strong><br>Must be EXACTLY 10x10 pixels and no animation</p>
          <input id="image" type="file" name="image" maxlength=100 accept="image/png" required>
          <p>Input: <img style="display:inline-block" id="input-image" width=10 height=10>, Check: <canvas style="display:inline-block" id="output-image" width=10 height=10>
          <hr>
          <p><strong>Your square title (we prepend your square number automatically)</strong><br>Maximum 64 bytes (some Unicode characters use multiple bytes)</p>
          <input id="title" type=text name="title" maxlength=64 required>
          <hr>
          <p><strong>Your square URL</strong><br>Maximum 96 bytes (some Unicode characters use multiple bytes)</p>
          <input id="url" type=text name="url" maxlength=96 required placeholder="https://...">
          <hr>
          <p><em>If you broke any rule above then the transaction will NOT go through and your ether will NOT be spent.</em></p>
          <hr>
          <button id="personalizeFree" type="button">Personalize Square (FREE)</button>
          <button id="personalize10" type="button">Personalize Square (10 finney)</button>
        </form>
      </div>
      <div class="step-4-done" style="display:none">
        <h2>&#x2705; Personalized square #<span class="square-number-plug"></span></h2>
      </div>
    </div>

    <div class="step-4-done" style="display:none">
      <h2>Step 4: Processing...</h2>
      <p>Thank you for personalizing!</p>
      <p>Your action is processing, your transaction ID is <a target="_blank" id="txlink" href=""><strong id="txid"></strong></a></p>
      <p>You can click that link about to check the progress. This should complete within one minute. (It will say "sorry, unable to locate" until then.)</p>
      <p>Once your transaction is complete, <strong>it may take up to 24 hours</strong> to show on the home page, and it will be public for everyone to see.</p>
    </div>

  </article>
  <footer>
    <small>
      Ten Thousand Su&trade; website &copy; Su Entriken. All rights reserved. Not responsible for the content of linked sites. Images shown on homepage are &copy; their respective owners.
    </small>
  </footer>
  <script>
    let app = window.suSquaresApplication;

    /* The web3 workflow ******************************************************/
    app.web3.then(()=>{
      $('.step-1-done').show();
      $('.step-1-not-done').hide();
    });
    app.networkId.then(()=>{
      $('.step-2-done').show();
      $('.step-2-not-done').hide();
    });
    app.accessEnabled.then(()=>{
      $('.step-3-done').show();
      $('.step-3-not-done').hide();
    });

    /* The application on this page *******************************************/
    $(async ()=>{
      try {
        var contract = await app.contract;
        var web3 = await app.web3;
      } catch(error) {
        alert(error);
      }

      /* Upfront stuff (non-interactive) **************************************/
      var pixelData = []; // pixels from selected image
      var ownedCount = 0; // balanceOf(owner)
      var loadedCount = 0; // count of loaded squares

      $('.wallet-plug').text(web3.eth.defaultAccount);
      contract.balanceOf(web3.eth.defaultAccount, (err, res)=>{
        console.log(['count', err, res, res.toString()]);
        if (!err) {
          $('.square-count').text(res);
          ownedCount = res;
          loadOwnedSquare();
        } else {
          alert(err);
        }
      });

      /* Helper functions *****************************************************/
      function loadOwnedSquare() {
        if (loadedCount >= ownedCount) {
          $('#square-number').val(window.suSquaresApplication.getSquareFromUrl());
          return;
        }
        contract.tokenOfOwnerByIndex(web3.eth.defaultAccount, loadedCount, (err, res)=>{
          console.log([err, res]);
          if (!err) {
            loadedCount++;
            $('#square-number').append($('<option>', {
              value: res,
              text: 'Square #' + res
            }));
            loadOwnedSquare();
          }
        });
      }

      function readURL(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            // Loaded the image
            $('#input-image').attr('src', e.target.result);
          }
          reader.readAsDataURL(input.files[0]);
        }
      }

      /* Interactive behavior *************************************************/
      $('#input-image').on('load',()=>{
        pixelData = [];
        var img = new Image();
        img.src = $('#input-image').attr('src');
        var inCanvas = document.createElement('canvas');
        var inContext = inCanvas.getContext('2d');
        inContext.drawImage(img, 0, 0);
        var inContextPixels = inContext.getImageData(0,0,10,10);
        for (var i = 0; i < inContextPixels.data.length; i += 4) {
          pixelData.push(inContextPixels.data[i]);
          pixelData.push(inContextPixels.data[i+1]);
          pixelData.push(inContextPixels.data[i+2]);
        }
        var outCanvas = $('#output-image')[0];
        var outContext = outCanvas.getContext('2d');
        outContext.putImageData(inContextPixels,0,0)
      });

      $("#image").change(function() {
        readURL(this);
      });

      $('#personalizeFree').on('click', ()=>{
        var squareNumber = $('#square-number').val();
        if (squareNumber < 1 || squareNumber > 10000) {
          alert('Square number must between 1 and 10,000, inclusive');
          return
        }
        var title = $('#title').val();
        if (title.length > 64) {
          alert('Title must be less than 64 bytes');
          return
        }
        var url = $('#url').val();
        if (url.length > 96) {
          alert('URL must be less than 96 bytes');
          return
        }
        if (pixelData.length != 300) {
          alert('There is a problem with your image');
          return
        }
        var pixelDataWire = "0x";
        for (var i = 0; i < pixelData.length; i++) {
          var hex = pixelData[i].toString(16);
          while (hex.length < 2) {
            hex = "0" + hex;
          }
          pixelDataWire += hex;
        }
        if (pixelDataWire.length != 602) {
          alert('There is a problem with encoding your image');
          return
        }
        contract.personalizeSquare(squareNumber, pixelDataWire, title, url, (err, res)=>{
          console.log([err, res]);
          if (!err) {
            $('.step-4-done').show();
            $('.step-4-not-done').hide();
            $(".square-number-plug").text(squareNumber);
            $("#txid").text(res);
            $("#txlink").attr('href',"https://etherscan.io/tx/"+res)
          } else {
            alert(err);
          }
        })
      });

      $('#personalize10').on('click', ()=>{
        var squareNumber = $('#square-number').val();
        if (squareNumber < 1 || squareNumber > 10000) {
          alert('Square number must between 1 and 10,000, inclusive');
          return
        }
        var title = $('#title').val();
        if (title.length > 64) {
          alert('Title must be less than 64 bytes');
          return
        }
        var url = $('#url').val();
        if (url.length > 96) {
          alert('URL must be less than 96 bytes');
          return
        }
        if (pixelData.length != 300) {
          alert('There is a problem with your image');
          return
        }
        var pixelDataWire = "0x";
        for (var i = 0; i < pixelData.length; i++) {
          var hex = pixelData[i].toString(16);
          while (hex.length < 2) {
            hex = "0" + hex;
          }
          pixelDataWire += hex;
        }
        if (pixelDataWire.length != 602) {
          alert('There is a problem with encoding your image');
          return
        }
        contract.personalizeSquare(squareNumber, pixelDataWire, title, url, {value: web3js.toWei(10, 'finney')}, (err, res)=>{
          console.log([err, res]);
          if (!err) {
            $('.step-4-done').show();
            $('.step-4-not-done').hide();
            $(".square-number-plug").text(squareNumber);
            $("#txid").text(res);
            $("#txlink").attr('href',"https://etherscan.io/tx/"+res)
          } else {
            alert(err);
          }
        })
      });
    });
  </script>
</body>
</html>
