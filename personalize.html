---
layout: null
image: "{{ site.baseurl }}/assets/images/su-OG.png"
---
<!doctype html>
<html lang="en" class="personalize-page">

<head>
  <script>window.SITE_BASEURL = "{{ site.baseurl }}";</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% include pwa-meta-tags.html %}
  {% seo %}
  <title>Personalize your Square for the homepage</title>
  <link rel="canonical" href="https://tenthousandsu.com/personalize" />
  <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/main.css">
  <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/personalize.css">
  <link rel="stylesheet" href="{{ site.baseurl }}/assets/web3/tx/styles.css">
  {% include nav-menu-head.html %}
  {% include alert-modal-head.html %}
  {% include offline-modal-head.html %}
  {% include jsonld-nav.html %}
  {% include jsonld/pages/personalize.html %}

</head>

<body>
  {% include nav-header.html desktop_button_one_label="Mint" desktop_button_one_href="/buy" %}

  <article class="lead">
    <h1>Personalize</h1>
    <p>
      <em>If you have any questions, please mail <a
          href="mailto:Su@TenThousandSu.com?subject=Personalize+underlay+batch">Su@TenThousandSu.com</a>. The price to
        personalize is <span id="personalize-price-display">0.001 ETH</span>.</em>
    </p>
    <p>
      Use this page to personalize a Su Square you own on TenThousandSu.com. To personalize many squares, try the <a
        href="{{ site.baseurl }}/personalize-batch">batch tool</a>. If your Square was previously personalized using the
      old, more
      expensive method you will need to <a href="#" id="open-unpersonalize-modal">unpersonalize</a>
      it first.
    </p>

    <h2>Select a Square</h2>
    <p>Which Square will you personalize?</p>
    <p>
      <input id="square-number" type="number" min="1" max="10000" required style="width:7em" placeholder="e.g. 7421">
    </p>

    <h2>Enter title</h2>
    <p>Enter a title for your Square.</p>
    <p>
      <input id="title" type="text" maxlength="64" placeholder="e.g. My Su Square">
    </p>
    <p><span id="title-count">0</span> of 64 bytes</p>

    <h2>Enter URL</h2>
    <p>Enter a URL for your Square. Typically this will start with <code>https://</code>.</p>
    <p>
      <input id="url" type="text" maxlength="96" placeholder="e.g. https://example.com">
    </p>
    <p><span id="url-count">0</span> of 96 bytes</p>

    <h2>Upload image</h2>
    <p>Design your image carefully to be 10&times;10 pixels.</p>
    <p>Do not use animation or transparency. PNG and some other formats can be used here.</p>
    <p>
      <input id="image" type="file" accept="image/png, image/jpeg, image/gif">
    </p>
    <p>
      Image status: <span id="image-status">no image selected</span>
    </p>
    <p>
      <canvas id="image-preview" style="width:0;height:0;image-rendering:pixelated;"></canvas>
    </p>

    <h2>Personalize</h2>
    <p>Click this button to personalize your Square.</p>
    <div class="wallet-actions">
      <button id="open-wallet-app" type="button" class="btn">Open mobile wallet</button>
      <button id="personalize" class="btn btn-lg">Personalize</button>
    </div>

    <div id="tx-fixture"></div>

    <!-- Unpersonalize Modal (lazy loaded) -->
    <div id="unpersonalize-modal" class="su-modal-overlay" aria-hidden="true">
      <div class="su-modal">
        <div class="su-modal__header">
          <h3 class="su-modal__title">Unpersonalize Square</h3>
          <button type="button" class="su-modal__close" aria-label="Close">&times;</button>
        </div>
        <div class="su-modal__body">
          <p class="su-modal__desc">Remove personalization from the main contract so you can use the cheaper underlay
            contract.</p>
          <div class="su-modal__field">
            <label for="unpersonalize-token-id" class="su-modal__label">Token ID</label>
            <input id="unpersonalize-token-id" class="su-modal__input" type="number" min="1" max="10000" required
              placeholder="e.g. 7421">
          </div>
          <div id="unpersonalize-status" class="su-modal__status"></div>
          <div id="unpersonalize-tx-fixture"></div>
          <div class="su-modal__actions">
            <button id="unpersonalize-submit" class="btn btn-primary" disabled>Unpersonalize</button>
          </div>
        </div>
      </div>
    </div>
  </article>

  <footer>
    <small>
      No cookies. No analytics. To the extent possible under law, Su Entriken has waived all copyright and related or
      neighboring rights to the TenThousandSu.com website. This work is published from the United States.
    </small>
  </footer>

  <script>
    (function() {
      var cfg = window.suWeb3 || window.SU_WEB3 || {};
      var pricing = cfg.pricing;
      if (pricing && typeof pricing.personalizePriceEth === "number" && pricing.personalizePriceEth !== 0.001) {
        var el = document.getElementById("personalize-price-display");
        if (el) el.textContent = pricing.personalizePriceEth + " ETH";
      }
    })();
  </script>

  <script type="module">
    import {
      ensureConnected,
      ensureCorrectNetwork,
      isMobileDevice,
      openWalletChooser,
    } from "{{ site.baseurl }}/assets/web3/foundation.js";
    import { createTxFixture } from "{{ site.baseurl }}/assets/web3/tx/index.js";
    import { getTxErrorMessage } from "{{ site.baseurl }}/assets/web3/tx/errors.js";
    import { getWeb3Config } from "{{ site.baseurl }}/assets/web3/config.js";
    import { personalizeUnderlay } from "{{ site.baseurl }}/assets/web3/services/underlay.js";
    import { buildTxUrl } from "{{ site.baseurl }}/assets/web3/services/explorer-links.js";
    import { maybeAlertBillboardUpdate } from "{{ site.baseurl }}/assets/web3/alerts.js";

    // Elements and state //////////////////////////////////////////////////////////////////////////////////////////////
    const squareNumberInput = document.getElementById("square-number");
    const titleInput = document.getElementById("title");
    const titleCountSpan = document.getElementById("title-count");
    const urlInput = document.getElementById("url");
    const urlCountSpan = document.getElementById("url-count");
    const imageInput = document.getElementById("image");
    const imageStatusSpan = document.getElementById("image-status");
    const imagePreviewCanvas = document.getElementById("image-preview");
    const openWalletButton = document.getElementById("open-wallet-app");
    const personalizeButton = document.getElementById("personalize");
    const txFixtureDiv = document.getElementById("tx-fixture");
    const { pricing } = getWeb3Config();
    const txUi = createTxFixture({
      target: txFixtureDiv,
      pricing,
      mode: "personalize",
      title: "Personalization status",
    });
    let squareNumber;
    let title;
    let url;
    let imagePixelsHex; // 0xRRGGBB.. of top-left pixel, pixel to its right, ...
    let currentWagmi = null; // Track current wagmi client for button visibility

    // Validate changes to #square-number //////////////////////////////////////////////////////////////////////////////
    // todo: look up and show warnings if Square is personalized on main contract (which occludes)
    squareNumberInput.addEventListener("input", (event) => {
      squareNumber = null;
      const value = parseInt(event.target.value);
      if (isNaN(value) || value < 1 || value > 10000) {
        return alert("Invalid Square number, please enter a number between 1 and 10000.");
      }
      squareNumber = value;
    });

    // Validate changes to #title //////////////////////////////////////////////////////////////////////////////////////
    titleInput.addEventListener("input", (event) => {
      title = null;
      const length = new TextEncoder().encode(event.target.value).length; // UTF-8 byte length
      titleCountSpan.innerText = length;
      if (length > 64) {
        return alert("Title is too long, please try again.");
      }
      if (length < 1) {
        return alert("Title is too short, please try again.");
      }
      title = event.target.value;
    });

    // Validate changes to #url ////////////////////////////////////////////////////////////////////////////////////////
    urlInput.addEventListener("input", (event) => {
      url = null;
      const length = new TextEncoder().encode(event.target.value).length; // UTF-8 byte length
      urlCountSpan.innerText = length;
      if (length > 96) {
        return alert("URL is too long, please try again.");
      }
      if (length < 1) {
        return alert("URL is too short, please try again.");
      }
      url = event.target.value;
    });

    // Validate changes to #image //////////////////////////////////////////////////////////////////////////////////////
    imageInput.addEventListener("change", (event) => {
      imagePixelsHex = null;
      imageStatusSpan.innerText = "Loading image…";
      imagePreviewCanvas.width = 0;
      imagePreviewCanvas.height = 0;
      if (!event.target.files || !event.target.files[0]) {
        imageStatusSpan.innerText = "No image selected";
        imageInput.value = "";
        return alert("Unable to read file");
      }
      const image = new Image();
      image.addEventListener("load", () => {
        if (image.width !== 10 || image.height !== 10) {
          imageStatusSpan.innerText = "No image selected";
          imageInput.value = "";
          return alert("IMAGE ERROR: Image must be 10×10 pixels. Please try again.");
        }
        if (image.naturalWidth !== image.width || image.naturalHeight !== image.height) {
          imageStatusSpan.innerText = "No image selected";
          imageInput.value = "";
          return alert("IMAGE ERROR: Image must not be animated. Please try again.");
        }
        imagePreviewCanvas.width = 10;
        imagePreviewCanvas.height = 10;
        const context = imagePreviewCanvas.getContext("2d");
        context.drawImage(image, 0, 0);
        const contextImageData = context.getImageData(0, 0, 10, 10);
        let alphaWarning = false;
        imagePixelsHex = "0x";
        for (let i = 0; i < contextImageData.data.length; i += 4) {
          const [red, green, blue, alpha] = contextImageData.data.slice(i, i + 4);
          // Mix color to a white background (255) if there is transparency
          const mixedRed = Math.floor((red * alpha + 255 * (255 - alpha)) / 255);
          const mixedGreen = Math.floor((green * alpha + 255 * (255 - alpha)) / 255);
          const mixedBlue = Math.floor((blue * alpha + 255 * (255 - alpha)) / 255);
          if (alpha != 255) alphaWarning = true;
          imagePixelsHex += mixedRed.toString(16).padStart(2, "0");
          imagePixelsHex += mixedGreen.toString(16).padStart(2, "0");
          imagePixelsHex += mixedBlue.toString(16).padStart(2, "0");
        }
        if (alphaWarning) {
          alert("WARNING: Your image included transparency. Since Su Squares does not support transparency, we have mixed down this color on top of a white background. Proceed at your own risk.");
        }
        imageStatusSpan.innerText = "Image loaded, shown here enlarged";
        imagePreviewCanvas.style.width = "100px";
        imagePreviewCanvas.style.height = "100px";
      });
      image.src = window.URL.createObjectURL(event.target.files[0]);
    });

    // Handle ?square= query parameter /////////////////////////////////////////////////////////////////////////////////
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("square")) {
      squareNumberInput.value = urlParams.get("square");
      squareNumberInput.dispatchEvent(new Event("input"));
    }

    // Open wallet button - shows on mobile when connected via WalletConnect
    const updateOpenWalletButton = () => {
      if (!openWalletButton) return;
      const isWalletConnect = currentWagmi?.getAccount?.()?.connector?.id === "walletConnect";
      const showButton = isMobileDevice() && isWalletConnect;
      openWalletButton.style.display = showButton ? "inline-block" : "none";
    };

    if (openWalletButton) {
      updateOpenWalletButton();
      openWalletButton.addEventListener("click", () => {
        // Opens OS app chooser with placeholder URI (no real session data exposed)
        openWalletChooser();
      });
    }

    // Handle personalize button ///////////////////////////////////////////////////////////////////////////////////////
    personalizeButton.addEventListener("click", async () => {
      if (!squareNumber) {
        return alert("Please enter a Square number.");
      }
      if (!title) {
        return alert("Please enter a title.");
      }
      if (!url) {
        return alert("Please enter a URL.");
      }
      if (!imagePixelsHex) {
        return alert("Please select an image.");
      }
      txUi.startProcessing(`Personalizing Square #${squareNumber}. Confirm in your wallet to continue.`);
      const doSendTransaction = async (wagmi) => {
        const isWalletConnect = wagmi?.getAccount?.()?.connector?.id === "walletConnect";
        txUi.setWalletContext({
          isWalletConnect,
        });
        // Trigger wallet app open on mobile for WalletConnect
        if (isMobileDevice() && isWalletConnect) {
          openWalletChooser();
        }
        let result;
        try {
          result = await personalizeUnderlay({ squareId: squareNumber, imagePixelsHex, title, url }, wagmi);
          const pendingUrl = buildTxUrl(result.hash);
          txUi.addPending(result.hash, pendingUrl);
          const transaction = await wagmi.waitForTransaction({ hash: result.hash });
          const txUrl = buildTxUrl(transaction.transactionHash);
          txUi.markSuccess(
            transaction.transactionHash,
            txUrl,
            "Transaction confirmed. Your image will show on the Su Squares homepage, which refreshes hourly."
          );
          maybeAlertBillboardUpdate();
        } catch (error) {
          console.log(error);
          const message = getTxErrorMessage(error, { isWalletConnect });
          txUi.markError(message);
          return alert(message);
        }
      };
      await ensureConnected(async (clients) => {
        currentWagmi = clients;
        updateOpenWalletButton();
        await ensureCorrectNetwork(clients);
        const { activeNetwork } = getWeb3Config();
        const account = clients.getAccount?.();
        if (account?.address) {
          txUi.setBalanceContext({
            address: account.address,
            chainId: activeNetwork.chainId,
            fetcher: (addr, chain) => clients.fetchBalance({ address: addr, chainId: chain }),
          });
        }
        await doSendTransaction(clients);
      });
    });

    // Unpersonalize Modal - Lazy Loaded /////////////////////////////////////////////////////////////////////////
    const unpersonalizeModalTrigger = document.getElementById("open-unpersonalize-modal");
    const unpersonalizeModal = document.getElementById("unpersonalize-modal");
    const unpersonalizeTokenInput = document.getElementById("unpersonalize-token-id");
    const unpersonalizeStatus = document.getElementById("unpersonalize-status");
    const unpersonalizeSubmit = document.getElementById("unpersonalize-submit");
    const unpersonalizeTxFixtureDiv = document.getElementById("unpersonalize-tx-fixture");
    const unpersonalizeCloseBtn = unpersonalizeModal?.querySelector(".su-modal__close");

    let unpersonalizeModuleLoaded = false;
    let unpersonalizeService = null;
    let unpersonalizeTxUi = null;

    function showUnpersonalizeModal() {
      if (!unpersonalizeModal) return;
      unpersonalizeModal.classList.add("is-visible");
      unpersonalizeModal.setAttribute("aria-hidden", "false");
      // Pre-fill token ID from main form if available
      if (squareNumber && unpersonalizeTokenInput) {
        unpersonalizeTokenInput.value = squareNumber;
        validateUnpersonalizeInput();
      }
    }

    function hideUnpersonalizeModal() {
      if (!unpersonalizeModal) return;
      unpersonalizeModal.classList.remove("is-visible");
      unpersonalizeModal.setAttribute("aria-hidden", "true");
      if (unpersonalizeTxUi) {
        unpersonalizeTxUi.reset();
      }
      if (unpersonalizeStatus) {
        unpersonalizeStatus.textContent = "";
        unpersonalizeStatus.className = "su-modal__status";
      }
    }

    async function loadUnpersonalizeModule() {
      if (unpersonalizeModuleLoaded) return;
      try {
        const [serviceModule, txModule] = await Promise.all([
          import("{{ site.baseurl }}/assets/web3/services/unpersonalize.js"),
          import("{{ site.baseurl }}/assets/web3/tx/index.js"),
        ]);
        unpersonalizeService = serviceModule;
        unpersonalizeTxUi = txModule.createTxFixture({
          target: unpersonalizeTxFixtureDiv,
          pricing,
          mode: "unpersonalize",
          title: "Unpersonalization status",
        });
        unpersonalizeModuleLoaded = true;
      } catch (error) {
        console.error("Failed to load unpersonalize module:", error);
        if (unpersonalizeStatus) {
          unpersonalizeStatus.textContent = "Failed to load module. Please refresh and try again.";
          unpersonalizeStatus.className = "su-modal__status su-modal__status--error";
        }
      }
    }

    async function validateUnpersonalizeInput() {
      const tokenId = parseInt(unpersonalizeTokenInput?.value);
      if (!tokenId || tokenId < 1 || tokenId > 10000) {
        if (unpersonalizeSubmit) unpersonalizeSubmit.disabled = true;
        if (unpersonalizeStatus) {
          unpersonalizeStatus.textContent = "";
          unpersonalizeStatus.className = "su-modal__status";
        }
        return false;
      }

      // Check personalization status on main contract
      if (unpersonalizeService?.checkMainContractStatus) {
        try {
          const status = await unpersonalizeService.checkMainContractStatus(tokenId);
          if (unpersonalizeStatus) {
            if (status.message) {
              unpersonalizeStatus.textContent = status.message;
              if (status.isOnMain && status.hasPersonalization) {
                unpersonalizeStatus.className = "su-modal__status su-modal__status--success";
              } else {
                unpersonalizeStatus.className = "su-modal__status su-modal__status--warning";
              }
            } else {
              unpersonalizeStatus.textContent = "";
              unpersonalizeStatus.className = "su-modal__status";
            }
          }
        } catch (error) {
          console.warn("Could not check personalization status:", error);
        }
      }

      if (unpersonalizeSubmit) unpersonalizeSubmit.disabled = false;
      return true;
    }

    if (unpersonalizeModalTrigger) {
      unpersonalizeModalTrigger.addEventListener("click", async (event) => {
        event.preventDefault();
        showUnpersonalizeModal();
        await loadUnpersonalizeModule();
      });
    }

    if (unpersonalizeCloseBtn) {
      unpersonalizeCloseBtn.addEventListener("click", hideUnpersonalizeModal);
    }

    if (unpersonalizeModal) {
      unpersonalizeModal.addEventListener("click", (event) => {
        if (event.target === unpersonalizeModal) {
          hideUnpersonalizeModal();
        }
      });
    }

    if (unpersonalizeTokenInput) {
      unpersonalizeTokenInput.addEventListener("input", validateUnpersonalizeInput);
    }

    if (unpersonalizeSubmit) {
      unpersonalizeSubmit.addEventListener("click", async () => {
        const tokenId = parseInt(unpersonalizeTokenInput?.value);
        if (!tokenId || tokenId < 1 || tokenId > 10000) {
          return alert("Please enter a valid Token ID (1-10000).");
        }

        if (!unpersonalizeService || !unpersonalizeTxUi) {
          return alert("Module not loaded. Please close and reopen the modal.");
        }

        unpersonalizeTxUi.startProcessing(`Unpersonalizing Square #${tokenId}. Confirm in your wallet to continue.`);

        await ensureConnected(async (clients) => {
          await ensureCorrectNetwork(clients);

          const isWalletConnect = clients?.getAccount?.()?.connector?.id === "walletConnect";
          unpersonalizeTxUi.setWalletContext({
            isWalletConnect,
          });
          // Trigger wallet app open on mobile for WalletConnect
          if (isMobileDevice() && isWalletConnect) {
            openWalletChooser();
          }

          // Set balance context
          const { activeNetwork } = getWeb3Config();
          const account = clients.getAccount?.();
          if (account?.address) {
            unpersonalizeTxUi.setBalanceContext({
              address: account.address,
              chainId: activeNetwork.chainId,
              fetcher: (addr, chain) => clients.fetchBalance({ address: addr, chainId: chain }),
            });
          }

          // Check ownership before proceeding
          try {
            const owner = await unpersonalizeService.checkSquareOwner(tokenId, clients);
            const signerAddress = account?.address;
            if (owner?.toLowerCase() !== signerAddress?.toLowerCase()) {
              unpersonalizeTxUi.markError("You do not own this Square.");
              return alert("You do not own this Square. Transaction cancelled.");
            }
          } catch (error) {
            console.error("Ownership check failed:", error);
            unpersonalizeTxUi.markError("Could not verify ownership. Please try again.");
            return;
          }

          // Proceed with unpersonalization
          try {
            const result = await unpersonalizeService.unpersonalizePrimary({ squareId: tokenId }, clients);
            const { buildTxUrl } = await import("{{ site.baseurl }}/assets/web3/services/explorer-links.js");
            const pendingUrl = buildTxUrl(result.hash);
            unpersonalizeTxUi.addPending(result.hash, pendingUrl);

            const transaction = await clients.waitForTransaction({ hash: result.hash });
            const txUrl = buildTxUrl(transaction.transactionHash);
            unpersonalizeTxUi.markSuccess(
              transaction.transactionHash,
              txUrl,
              "Square unpersonalized! You can now personalize using the cheaper underlay contract."
            );
          } catch (error) {
            console.error("Unpersonalize transaction failed:", error);
            const message = getTxErrorMessage(error, { isWalletConnect });
            unpersonalizeTxUi.markError(message);
            return alert(message);
          }
        });
      });
    }
  </script>
  <script src="{{ site.baseurl }}/assets/js/pwa-init.js"></script>
</body>

</html>
